name: Build Alpine LXQt Custom ISO

on:
  push:
    branches:
      - main
  # Gatilho para iniciar na criação de uma nova tag de release
  create:
    tags:
      - 'v*'

jobs:
  build_lxqt_iso:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout do Código Principal
        uses: actions/checkout@v4
        
      # NOVO PASSO DE CORREÇÃO: Adicionar permissão de execução
      - name: 1.5. Garantir Permissão de Execução ao Script
        run: chmod +x run_lxqt_build.sh
        
      - name: 2. Clonar alpine-make-vm-image e Criar Diretório Aports
        # Clona o repositório base necessário no HOST (runner)
        run: |
          echo "Clonando alpine-make-vm-image e criando diretórios de trabalho..."
          git clone --depth=1 https://github.com/alpinelinux/alpine-make-vm-image.git
          mkdir aports
          mkdir iso_output

      - name: 3. Construir Imagem Docker (Ambiente de Build)
        id: docker_build
        # Constrói o Dockerfile para criar o ambiente com todas as ferramentas e a chave ABBUILD
        run: |
          docker build -t alpine-lxqt-builder .
          echo "IMAGE_ID=alpine-lxqt-builder" >> $GITHUB_OUTPUT

      - name: 4. Executar Contêiner e Gerar ISO (Executa o Script Customizado)
        # Mapeia o diretório raiz do repositório para /workspace no contêiner.
        run: |
          echo "Executando o script de build customizado no contêiner..."
          
          # A variável de ambiente ISO_TAG é definida com base na tag do Git, se existir, senão usa o padrão do script.
          # Isso permite que o nome da ISO gerada reflita a versão do release.
          TAG_NAME="${{ github.ref_name }}"
          if [ "${TAG_NAME}" = "main" ]; then
            ISO_TAG_ENV="latest"
          else
            ISO_TAG_ENV="${TAG_NAME}"
          fi
          
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -e ISO_TAG="${ISO_TAG_ENV}" \
            "${{ steps.docker_build.outputs.IMAGE_ID }}" \
            /bin/sh -c "/workspace/run_lxqt_build.sh"

      - name: 5. Fazer Upload da ISO como Artefato
        uses: actions/upload-artifact@v4
        with:
          name: alpine-lxqt-custom-iso
          # Busca a ISO que foi salva em 'iso_output' no host pelo script
          path: ${{ github.workspace }}/iso_output/*.iso
          retention-days: 7
          
      - name: 6. Criar Release e Anexar ISO (Apenas se o gatilho for 'create tag')
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/iso_output/*.iso
          body: |
            Nova ISO customizada do Alpine Linux (LXQt) baseada na tag ${{ github.ref_name }}.
