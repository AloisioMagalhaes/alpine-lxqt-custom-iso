name: Build Alpine Custom ISO

on:
  push:
    branches:
      - main
  # Gatilho para iniciar na criação de uma nova tag de release
  create:
    tags:
      - 'v*'

jobs:
  build_and_publish_iso:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4
        # Garante que todo o histórico seja buscado para o build

      - name: 2. Construir Imagem Docker
        id: docker_build
        run: |
          docker build -t alpine-iso-custom .
          echo "IMAGE_ID=alpine-iso-custom" >> $GITHUB_OUTPUT

      - name: 3. Executar Contêiner e Gerar ISO
        # O diretório de trabalho do GitHub Actions é mapeado como /github/workspace
        run: |
          # Cria o diretório de saída no host do runner
          mkdir -p iso_output
          
          # Executa o contêiner
          # -v "${{ github.workspace }}":/workspace mapeia o diretório do repositório
          # O script interno salvará a ISO em /workspace/iso, que é mapeado para ${{ github.workspace }}/iso
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            "${{ steps.docker_build.outputs.IMAGE_ID }}" \
            ./build_custom_iso.sh

      - name: 4. Fazer Upload da ISO como Artefato
        uses: actions/upload-artifact@v4
        with:
          name: alpine-custom-iso
          # O arquivo gerado pelo script estará em /workspace/iso, que no host é ${{ github.workspace }}/iso
          path: ${{ github.workspace }}/iso/*.iso
          retention-days: 7
          
      - name: 5. Criar Release e Anexar ISO (Opcional, se o gatilho for 'create tag')
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/iso/*.iso
          body: |
            Release automática da ISO customizada do Alpine Linux.
            Tag: ${{ github.ref_name }}
