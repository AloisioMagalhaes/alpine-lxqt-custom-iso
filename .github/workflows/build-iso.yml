name: Alpine Custom ISO Builder

on:
  # Dispara o build quando uma nova tag que começa com 'v' é criada (ex: v1.0)
  push:
    tags:
      - 'v*'
  # Permite execução manual pela interface do GitHub
  workflow_dispatch: 

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4
        
      - name: 2. Configurar o QEMU (Necessário para builds não nativas se houver multi-arch)
        # Embora você esteja usando x86_64, é bom para compatibilidade
        uses: docker/setup-qemu-action@v3
      
      - name: 3. Configurar Buildx
        uses: docker/setup-buildx-action@v3

      - name: 4. Construir e Rodar o Contêiner Alpine Build
        id: run_build
        # Construímos e rodamos o contêiner em uma única etapa
        run: |
          docker build -t alpine-iso-builder .
          docker run --rm \
            -v ${{ github.workspace }}:${{ github.workspace }} \
            -w ${{ github.workspace }} \
            alpine-iso-builder

      - name: 5. Localizar e Mover Arquivo ISO
        # O script build_alpine_custom.sh gera a ISO em /workspace/iso no contêiner.
        # Devido ao mapeamento de volume, o arquivo está em ./iso/ no host.
        run: |
          ISO_FILE=$(find ./iso -name "*.iso")
          if [ -z "$ISO_FILE" ]; then
            echo "❌ Erro: Arquivo ISO não encontrado em ./iso."
            exit 1
          fi
          echo "ISO_PATH=$ISO_FILE" >> $GITHUB_ENV
          echo "ISO_NAME=$(basename $ISO_FILE)" >> $GITHUB_ENV

      - name: 6. Criar GitHub Release e Fazer Upload
        # Dispara apenas quando o workflow foi executado por uma TAG
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ISO_PATH }}
          name: Release ${{ github.ref_name }} - Alpine LXQt
          tag_name: ${{ github.ref_name }}
          body: |
            Imagem ISO customizada do Alpine Linux com LXQt, drivers de laptop e instalação automática.
            Build gerado automaticamente via GitHub Actions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
