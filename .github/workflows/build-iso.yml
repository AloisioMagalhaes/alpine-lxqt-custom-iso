name: Build Alpine LXQt Custom ISO

on:
  push:
    branches:
      - main
  # Gatilho para iniciar na criação de uma nova tag de release
  create:
    tags:
      - 'v*'

jobs:
  build_lxqt_iso:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout do Código Principal
        uses: actions/checkout@v4
        
      - name: 2. Clonar Repositórios e Preparar Diretórios
        run: |
          echo "Clonando alpine-make-vm-image e criando diretórios de trabalho..."
          
          # Clonagem do alpine-make-vm-image
          git clone --depth=1 https://github.com/alpinelinux/alpine-make-vm-image.git
          
          # ----------------------------------------------------------------------
          # CORREÇÃO DEFINITIVA: O nome do script é 'alpine-make-vm-image'
          # ----------------------------------------------------------------------
          SCRIPT_PATH="alpine-make-vm-image/alpine-make-vm-image"
          
          if [ -f "${SCRIPT_PATH}" ]; then
            echo "Concedendo permissão de execução para ${SCRIPT_PATH}..."
            chmod +x "${SCRIPT_PATH}"
          else
            echo "ERRO: O script ${SCRIPT_PATH} não foi encontrado após a clonagem."
            ls -l alpine-make-vm-image/ # Mantém o ls -l para diagnóstico futuro
            exit 1
          fi
          
          # Criação dos diretórios de saída e aports
          mkdir aports
          mkdir iso_output

      - name: 3. Garantir Permissão de Execução ao Script Wrapper
        # Concede permissão ao seu script run_lxqt_build.sh
        run: chmod +x run_lxqt_build.sh
        
      - name: 4. Construir Imagem Docker (Ambiente de Build)
        # Mapeia o diretório raiz do repositório para /workspace no contêiner.
        run: |
          echo "Executando o script de build customizado no contêiner..."
          
          # A variável de ambiente ISO_TAG é definida com base na tag do Git, se existir, senão usa o padrão do script.
          # Isso permite que o nome da ISO gerada reflita a versão do release.
          TAG_NAME="${{ github.ref_name }}"
          if [ "${TAG_NAME}" = "main" ]; then
            ISO_TAG_ENV="latest"
          else
            ISO_TAG_ENV="${TAG_NAME}"
          fi
          
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -e ISO_TAG="${ISO_TAG_ENV}" \
            "${{ steps.docker_build.outputs.IMAGE_ID }}" \
            /bin/sh -c "/workspace/run_lxqt_build.sh"

      - name: 5. Fazer Upload da ISO como Artefato
        uses: actions/upload-artifact@v4
        with:
          name: alpine-lxqt-custom-iso
          # Busca a ISO que foi salva em 'iso_output' no host pelo script
          path: ${{ github.workspace }}/iso_output/*.iso
          retention-days: 7
          
      - name: 6. Criar Release e Anexar ISO (Apenas se o gatilho for 'create tag')
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/iso_output/*.iso
          body: |
            Nova ISO customizada do Alpine Linux (LXQt) baseada na tag ${{ github.ref_name }}.
